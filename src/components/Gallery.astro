---
const content = {
    id: {
        eyebrow: "Galeri Visual",
        title: "Keindahan Nusantara",
        subtitle: "Momen-momen yang menangkap esensi budaya Indonesia",
    },
    en: {
        eyebrow: "Visual Gallery",
        title: "Beauty of Nusantara",
        subtitle: "Moments capturing the essence of Indonesian culture",
    },
};

const categories = [
    { id: "all", labelId: "Semua", labelEn: "All" },
    { id: "budaya", labelId: "Budaya", labelEn: "Culture" },
    { id: "wisata_alam", labelId: "Wisata Alam", labelEn: "Nature Tourism" },
    {
        id: "bangunan_bersejarah",
        labelId: "Bangunan Bersejarah",
        labelEn: "Historical Buildings",
    },
    { id: "kuliner", labelId: "Kuliner", labelEn: "Culinary" },
];

import { GalleryItems as galleryItems } from "../constant/gallery";
---

<section class="gallery section section--alt bg-gallery-texture" id="gallery">
    <div class="container">
        <!-- Section Header -->
        <div class="section-header fade-up">
            <span
                class="section-header__eyebrow"
                data-content-id={content.id.eyebrow}
                data-content-en={content.en.eyebrow}
            >
                {content.id.eyebrow}
            </span>
            <h2
                class="section-header__title"
                data-content-id={content.id.title}
                data-content-en={content.en.title}
            >
                {content.id.title}
            </h2>
            <p
                class="section-header__subtitle"
                data-content-id={content.id.subtitle}
                data-content-en={content.en.subtitle}
            >
                {content.id.subtitle}
            </p>
        </div>

        <!-- Filter Tabs -->
        <div class="gallery__filters fade-up">
            {
                categories.map((cat, index) => (
                    <button
                        class={`gallery__filter ${index === 0 ? "active" : ""}`}
                        data-filter={cat.id}
                        data-label-id={cat.labelId}
                        data-label-en={cat.labelEn}
                    >
                        {cat.labelId}
                    </button>
                ))
            }
        </div>

        <!-- Masonry Grid -->
        <div class="gallery__grid" id="gallery-grid">
            {
                galleryItems.map((item) => (
                    <div
                        class={`gallery-item gallery-item--${item.size}`}
                        data-category={item.category}
                        data-id={item.id}
                    >
                        <div class="gallery-item__image-wrapper">
                            <img
                                src={item.image}
                                alt={item.titleId}
                                class="gallery-item__image"
                                loading="lazy"
                            />
                            <div class="gallery-item__overlay">
                                <span class="gallery-item__badge">
                                    {item.category}
                                </span>
                            </div>
                            <div class="gallery-item__caption">
                                <h4
                                    class="gallery-item__title"
                                    data-content-id={item.titleId}
                                    data-content-en={item.titleEn}
                                >
                                    {item.titleId}
                                </h4>
                                <span
                                    class="gallery-item__location"
                                    data-content-id={item.locationId}
                                    data-content-en={item.locationEn}
                                >
                                    üìç {item.locationId}
                                </span>
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <!-- Pagination -->
        <div class="pagination-container" id="gallery-pagination">
            <button
                class="pagination-arrow pagination-prev"
                id="pagination-prev"
                aria-label="Previous page"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div class="pagination-numbers" id="pagination-numbers"></div>
            <button
                class="pagination-arrow pagination-next"
                id="pagination-next"
                aria-label="Next page"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox__close" id="lightbox-close" aria-label="Close"
            >‚úï</button
        >
        <button
            class="lightbox__nav lightbox__nav--prev"
            id="lightbox-prev"
            aria-label="Previous">‚Äπ</button
        >
        <button
            class="lightbox__nav lightbox__nav--next"
            id="lightbox-next"
            aria-label="Next">‚Ä∫</button
        >
        <div class="lightbox__content">
            <img src="" alt="" class="lightbox__image" id="lightbox-image" />
            <div class="lightbox__info">
                <h3 class="lightbox__title" id="lightbox-title"></h3>
                <p class="lightbox__caption" id="lightbox-caption"></p>
            </div>
        </div>
        <div class="lightbox__thumbnails" id="lightbox-thumbnails"></div>
    </div>
</section>

<!-- Gallery Data for JS -->
<script define:vars={{ galleryItems }}>
    window.galleryData = galleryItems;
</script>

<style>
    /* Gallery Texture Background */
    .bg-gallery-texture {
        position: relative;
    }

    .bg-gallery-texture::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("https://res.cloudinary.com/dmx8hcmxh/image/upload/v1767775324/Untitled_design_2_qridiu.png");
        background-size: 300px;
        background-repeat: repeat;
        opacity: 0.08;
        pointer-events: none;
        z-index: 0;
    }

    .bg-gallery-texture > * {
        position: relative;
        z-index: 1;
    }

    .gallery {
        overflow: hidden;
        background-color: var(--charcoal);
    }

    /* Override section header colors for gallery */
    .gallery .section-header__eyebrow {
        color: var(--terracotta);
    }

    .gallery .section-header__title {
        color: var(--warm-white);
    }

    .gallery .section-header__subtitle {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Filter Tabs */
    .gallery__filters {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: var(--space-sm);
        margin-bottom: var(--space-3xl);
    }

    .gallery__filter {
        padding: var(--space-sm) var(--space-lg);
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-2xl);
        font-family: var(--font-sans);
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--warm-white);
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .gallery__filter:hover {
        background-color: var(--terracotta);
        border-color: var(--terracotta);
        color: var(--warm-white);
    }

    .gallery__filter.active {
        background-color: var(--terracotta);
        border-color: var(--terracotta);
        color: var(--warm-white);
    }

    /* Masonry Grid */
    .gallery__grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: 200px;
        gap: var(--space-md);
    }

    .gallery-item {
        position: relative;
        border-radius: var(--radius-lg);
        overflow: hidden;
        cursor: default;
        transition: all var(--transition-base);
    }

    .gallery-item--large {
        grid-column: span 2;
        grid-row: span 2;
    }

    .gallery-item--medium {
        grid-column: span 1;
        grid-row: span 2;
    }

    .gallery-item--small {
        grid-column: span 1;
        grid-row: span 1;
    }

    .gallery-item.hidden {
        display: none;
    }

    .gallery-item__image-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .gallery-item__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform var(--transition-slow);
    }

    .gallery-item:hover .gallery-item__image {
        transform: scale(1.05);
    }

    .gallery-item__overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            180deg,
            rgba(27, 27, 27, 0) 0%,
            rgba(27, 27, 27, 0.7) 100%
        );
        opacity: 0;
        transition: opacity var(--transition-base);
    }

    .gallery-item:hover .gallery-item__overlay {
        opacity: 1;
    }

    .gallery-item__badge {
        position: absolute;
        top: var(--space-md);
        left: var(--space-md);
        padding: var(--space-xs) var(--space-sm);
        background-color: var(--terracotta);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        color: var(--warm-white);
        opacity: 0;
        transform: translateY(-10px);
        transition: all var(--transition-base);
    }

    .gallery-item:hover .gallery-item__badge {
        opacity: 1;
        transform: translateY(0);
    }

    .gallery-item__caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: var(--space-lg);
        color: var(--warm-white);
        transform: translateY(100%);
        transition: transform var(--transition-base);
    }

    .gallery-item:hover .gallery-item__caption {
        transform: translateY(0);
        color: white;
    }

    .gallery-item__title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--space-xs);
        color: white;
    }

    .gallery-item__location {
        font-size: var(--text-sm);
        opacity: 0.8;
    }

    /* Lightbox Thumbnails */
    .lightbox__thumbnails {
        position: absolute;
        bottom: var(--space-xl);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: var(--space-sm);
        padding: var(--space-sm);
        background-color: rgba(27, 27, 27, 0.5);
        border-radius: var(--radius-lg);
    }

    .lightbox__thumb {
        width: 60px;
        height: 60px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity var(--transition-fast);
        border: 2px solid transparent;
    }

    .lightbox__thumb.active,
    .lightbox__thumb:hover {
        opacity: 1;
        border-color: var(--terracotta);
    }

    .lightbox__thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .gallery__grid {
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 180px;
        }

        .gallery-item--large {
            grid-column: span 2;
        }
    }

    @media (max-width: 768px) {
        .gallery__grid {
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 150px;
        }

        .gallery-item--large,
        .gallery-item--medium {
            grid-column: span 1;
            grid-row: span 2;
        }
    }

    @media (max-width: 480px) {
        .gallery__grid {
            grid-template-columns: 1fr;
            grid-auto-rows: 200px;
        }

        .gallery-item--large,
        .gallery-item--medium,
        .gallery-item--small {
            grid-column: span 1;
            grid-row: span 1;
        }

        .lightbox__thumbnails {
            display: none;
        }
    }

    /* New Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin-top: 64px;
    }

    .pagination-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: transparent;
        border: 1px solid #ffffff;
        border-radius: 50%;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .pagination-arrow:hover:not(:disabled) {
        background: #dc2626;
        border-color: #ffffff;
    }

    .pagination-arrow:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .pagination-numbers {
        display: flex;
        gap: 8px;
    }

    @media (max-width: 768px) {
        .pagination-container {
            gap: 8px;
        }

        .pagination-arrow {
            width: 36px;
            height: 36px;
        }
    }
</style>

<style is:global>
    .pagination-num {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: transparent;
        border: 1px solid #ffffff;
        border-radius: 50%;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        color: #dc2626;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .pagination-num:hover {
        background: rgba(220, 38, 38, 0.2);
    }

    .pagination-num.active {
        background: #dc2626;
        color: #ffffff;
    }

    .pagination-dots {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        color: #ffffff;
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .pagination-num {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }
</style>

<script>
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const galleryData = (window as any).galleryData;
    const galleryGrid = document.getElementById("gallery-grid");
    const galleryItems = document.querySelectorAll(".gallery-item");
    const filterBtns = document.querySelectorAll(".gallery__filter");

    // Pagination elements
    const paginationPrev = document.getElementById("pagination-prev");
    const paginationNext = document.getElementById("pagination-next");
    const paginationNumbers = document.getElementById("pagination-numbers");

    // Lightbox elements
    const lightbox = document.getElementById("lightbox");
    const lightboxImage = document.getElementById(
        "lightbox-image",
    ) as HTMLImageElement;
    const lightboxTitle = document.getElementById("lightbox-title");
    const lightboxCaption = document.getElementById("lightbox-caption");
    const lightboxClose = document.getElementById("lightbox-close");
    const lightboxPrev = document.getElementById("lightbox-prev");
    const lightboxNext = document.getElementById("lightbox-next");
    const lightboxThumbnails = document.getElementById("lightbox-thumbnails");

    let currentIndex = 0;
    let currentLang = localStorage.getItem("lang") || "id";
    let filteredItems = [...galleryData];

    // Pagination state
    const ITEMS_PER_PAGE = 8;
    let currentPage = 1;
    let totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);

    // Initialize pagination
    function updatePagination() {
        totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);

        // Ensure currentPage is valid
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        // Update button states
        if (paginationPrev) {
            (paginationPrev as HTMLButtonElement).disabled = currentPage === 1;
        }
        if (paginationNext) {
            (paginationNext as HTMLButtonElement).disabled =
                currentPage === totalPages;
        }

        // Generate page numbers
        if (paginationNumbers) {
            paginationNumbers.innerHTML = "";

            const maxVisiblePages = 5;
            let startPage = Math.max(
                1,
                currentPage - Math.floor(maxVisiblePages / 2),
            );
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // First page
            if (startPage > 1) {
                paginationNumbers.innerHTML += `<button class="pagination-num" data-page="1">1</button>`;
                if (startPage > 2) {
                    paginationNumbers.innerHTML += `<span class="pagination-dots">...</span>`;
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationNumbers.innerHTML += `<button class="pagination-num ${i === currentPage ? "active" : ""}" data-page="${i}">${i}</button>`;
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationNumbers.innerHTML += `<span class="pagination-dots">...</span>`;
                }
                paginationNumbers.innerHTML += `<button class="pagination-num" data-page="${totalPages}">${totalPages}</button>`;
            }

            // Add click handlers to page numbers
            paginationNumbers
                .querySelectorAll(".pagination-num")
                .forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const page = parseInt(
                            (btn as HTMLElement).dataset.page || "1",
                        );
                        goToPage(page);
                    });
                });
        }
    }

    function displayPage() {
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const currentFilter =
            document
                .querySelector(".gallery__filter.active")
                ?.getAttribute("data-filter") || "all";

        // Show/hide pagination based on filter
        const paginationContainer =
            document.getElementById("gallery-pagination");
        if (paginationContainer) {
            if (currentFilter === "all") {
                paginationContainer.style.display = "flex";
            } else {
                paginationContainer.style.display = "none";
            }
        }

        galleryItems.forEach((item) => {
            const itemId = parseInt((item as HTMLElement).dataset.id || "0");
            const category = (item as HTMLElement).dataset.category;

            // Find if this item is in the filtered list
            const itemIndex = filteredItems.findIndex(
                (fi: any) => fi.id === itemId,
            );

            // Check category filter and pagination
            const matchesFilter =
                currentFilter === "all" || category === currentFilter;

            // Only apply pagination for "all" filter
            const inPageRange =
                currentFilter === "all"
                    ? itemIndex >= startIndex && itemIndex < endIndex
                    : true;

            if (matchesFilter && inPageRange) {
                (item as HTMLElement).classList.remove("hidden");
                gsap.fromTo(
                    item,
                    { opacity: 0, scale: 0.9, y: 20 },
                    {
                        opacity: 1,
                        scale: 1,
                        y: 0,
                        duration: 0.4,
                        ease: "power2.out",
                    },
                );
            } else {
                (item as HTMLElement).classList.add("hidden");
            }
        });

        updatePagination();
    }

    function goToPage(page: number) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        displayPage();

        // Scroll to gallery section
        const gallerySection = document.getElementById("gallery");
        if (gallerySection) {
            gallerySection.scrollIntoView({
                behavior: "smooth",
                block: "start",
            });
        }
    }

    // Pagination event listeners
    paginationPrev?.addEventListener("click", () => goToPage(currentPage - 1));
    paginationNext?.addEventListener("click", () => goToPage(currentPage + 1));

    // Initialize display
    displayPage();

    // Filter functionality
    filterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const filter = (btn as HTMLElement).dataset.filter;

            // Update active state
            filterBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            // Update filtered items array
            filteredItems =
                filter === "all"
                    ? [...galleryData]
                    : galleryData.filter(
                          (item: any) => item.category === filter,
                      );

            // Reset to page 1 and display
            currentPage = 1;
            displayPage();
        });
    });

    // Lightbox functionality
    function openLightbox(index: number) {
        currentIndex = index;
        updateLightbox();
        lightbox?.classList.add("active");
        document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
        lightbox?.classList.remove("active");
        document.body.style.overflow = "";
    }

    function updateLightbox() {
        const item = filteredItems[currentIndex];
        if (!item || !lightboxImage || !lightboxTitle || !lightboxCaption)
            return;

        lightboxImage.src = item.image;
        lightboxImage.alt = currentLang === "id" ? item.titleId : item.titleEn;
        lightboxTitle.textContent =
            currentLang === "id" ? item.titleId : item.titleEn;
        lightboxCaption.textContent = `üìç ${currentLang === "id" ? item.locationId : item.locationEn}`;

        // Update thumbnails
        if (lightboxThumbnails) {
            lightboxThumbnails.innerHTML = filteredItems
                .map(
                    (it: any, idx: number) => `
        <div class="lightbox__thumb ${idx === currentIndex ? "active" : ""}" data-index="${idx}">
          <img src="${it.image}" alt="" />
        </div>
      `,
                )
                .join("");

            // Thumbnail click handlers
            lightboxThumbnails
                .querySelectorAll(".lightbox__thumb")
                .forEach((thumb) => {
                    thumb.addEventListener("click", () => {
                        const idx = parseInt(
                            (thumb as HTMLElement).dataset.index || "0",
                        );
                        openLightbox(idx);
                    });
                });
        }
    }

    function navigateLightbox(direction: number) {
        currentIndex =
            (currentIndex + direction + filteredItems.length) %
            filteredItems.length;
        updateLightbox();

        gsap.fromTo(
            lightboxImage,
            {
                opacity: 0,
                x: direction * 50,
            },
            {
                opacity: 1,
                x: 0,
                duration: 0.3,
            },
        );
    }

    lightboxClose?.addEventListener("click", closeLightbox);
    lightboxPrev?.addEventListener("click", () => navigateLightbox(-1));
    lightboxNext?.addEventListener("click", () => navigateLightbox(1));

    lightbox?.addEventListener("click", (e) => {
        if (e.target === lightbox) closeLightbox();
    });

    // Keyboard navigation
    document.addEventListener("keydown", (e) => {
        if (!lightbox?.classList.contains("active")) return;

        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") navigateLightbox(-1);
        if (e.key === "ArrowRight") navigateLightbox(1);
    });

    // Language change handler
    window.addEventListener("langchange", (e: CustomEvent) => {
        currentLang = e.detail.lang;

        // Update filter labels
        filterBtns.forEach((btn) => {
            const labelId = (btn as HTMLElement).dataset.labelId;
            const labelEn = (btn as HTMLElement).dataset.labelEn;
            btn.textContent = currentLang === "id" ? labelId : labelEn;
        });

        // Update gallery item titles
        document
            .querySelectorAll(".gallery-item [data-content-id]")
            .forEach((el) => {
                const contentId = el.getAttribute("data-content-id");
                const contentEn = el.getAttribute("data-content-en");

                if (el.classList.contains("gallery-item__location")) {
                    el.textContent = `üìç ${currentLang === "id" ? contentId : contentEn}`;
                } else {
                    el.textContent =
                        currentLang === "id" ? contentId : contentEn;
                }
            });

        // Update lightbox if open
        if (lightbox?.classList.contains("active")) {
            updateLightbox();
        }
    });
</script>
